#!/bin/bash
set -e
LOCAL_STAGE="file:///home/files"
SNOWFLAKE_STAGE="ontology_import"
FILE_FORMAT="ontology_import_format"
COPY_PARAMETERS=""
PUT_PARAMETERS="AUTO_COMPRESS=FALSE SOURCE_COMPRESSION=NONE OVERWRITE=TRUE"
# CONNECT TO SNOWFLAKE
snowsql -c etl_user <<- EOSQL

--- CREATE FILE FORMAT
CREATE OR REPLACE FILE FORMAT $FILE_FORMAT
TYPE = CSV
FIELD_DELIMITER = '\t'
EMPTY_FIELD_AS_NULL = true
TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS'
NULL_IF = ()
COMPRESSION=NONE
FIELD_OPTIONALLY_ENCLOSED_BY='"'
SKIP_HEADER=1;

--- CREATE STAGE AREA
CREATE OR REPLACE STAGE $SNOWFLAKE_STAGE FILE_FORMAT = $FILE_FORMAT;

-- PUT LOCAL FILES INTO SNOWFLAKE STAGE
PUT $LOCAL_STAGE/* @$SNOWFLAKE_STAGE $PUT_PARAMETERS;


--- COPY ONTOLOGY TABLES FROM THE STAGE
TRUNCATE ACT_COVID_V4;
TRUNCATE ACT_CPT4_PX_V4;
TRUNCATE ACT_DEM_V4;
TRUNCATE ACT_HCPCS_PX_V4;
TRUNCATE ACT_ICD10CM_DX_V4;
TRUNCATE ACT_ICD10PCS_PX_V4;
TRUNCATE ACT_ICD10_ICD9_DX_V4;
TRUNCATE ACT_ICD9CM_DX_V4;
TRUNCATE ACT_ICD9CM_PX_V4;
TRUNCATE ACT_LOINC_LAB_PROV_V4;
TRUNCATE ACT_LOINC_LAB_V4;
TRUNCATE ACT_MED_ALPHA_V4;
TRUNCATE ACT_MED_VA_V4;
TRUNCATE ACT_SDOH_V4;
TRUNCATE ACT_VISIT_DETAILS_V4;
TRUNCATE ACT_VITAL_SIGNS_V4;
TRUNCATE SCHEMES;
TRUNCATE TABLE_ACCESS;

COPY INTO ACT_COVID_V4 from @$SNOWFLAKE_STAGE/ACT_COVID_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_CPT4_PX_V4 from @$SNOWFLAKE_STAGE/ACT_CPT4_PX_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_DEM_V4 from @$SNOWFLAKE_STAGE/ACT_DEM_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_HCPCS_PX_V4 from @$SNOWFLAKE_STAGE/ACT_HCPCS_PX_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_ICD10CM_DX_V4 from @$SNOWFLAKE_STAGE/ACT_ICD10CM_DX_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_ICD10PCS_PX_V4 from @$SNOWFLAKE_STAGE/ACT_ICD10PCS_PX_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_ICD10_ICD9_DX_V4 from @$SNOWFLAKE_STAGE/ACT_ICD10_ICD9_DX_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_ICD9CM_DX_V4 from @$SNOWFLAKE_STAGE/ACT_ICD9CM_DX_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_ICD9CM_PX_V4 from @$SNOWFLAKE_STAGE/ACT_ICD9CM_PX_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_LOINC_LAB_PROV_V4 from @$SNOWFLAKE_STAGE/ACT_LOINC_LAB_PROV_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_LOINC_LAB_V4 from @$SNOWFLAKE_STAGE/ACT_LOINC_LAB_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_MED_ALPHA_V4 from @$SNOWFLAKE_STAGE/ACT_MED_ALPHA_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_MED_VA_V4 from @$SNOWFLAKE_STAGE/ACT_MED_VA_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_SDOH_V4 from @$SNOWFLAKE_STAGE/ACT_SDOH_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_VISIT_DETAILS_V4 from @$SNOWFLAKE_STAGE/ACT_VISIT_DETAILS_V4.csv $COPY_PARAMETERS;
COPY INTO ACT_VITAL_SIGNS_V4 from @$SNOWFLAKE_STAGE/ACT_VITAL_SIGNS_V4.csv $COPY_PARAMETERS;
COPY INTO SCHEMES from @$SNOWFLAKE_STAGE/SCHEMES.csv $COPY_PARAMETERS;
COPY INTO TABLE_ACCESS from @$SNOWFLAKE_STAGE/TABLE_ACCESS.csv $COPY_PARAMETERS;

--- COPY DATA TABLES FROM THE STAGE
TRUNCATE I2B2DATA.CONCEPT_DIMENSION;
TRUNCATE I2B2DATA.QT_BREAKDOWN_PATH;

COPY INTO I2B2DATA.CONCEPT_DIMENSION FROM @$SNOWFLAKE_STAGE/CONCEPT_DIMENSION.csv $COPY_PARAMETERS;
COPY INTO I2B2DATA.QT_BREAKDOWN_PATH FROM @$SNOWFLAKE_STAGE/QT_BREAKDOWN_PATH.csv $COPY_PARAMETERS;
EOSQL
