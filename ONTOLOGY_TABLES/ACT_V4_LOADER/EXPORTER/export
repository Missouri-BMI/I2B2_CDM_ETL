#!/bin/bash
set -e

LOCAL_STAGE="file:///home/stage"
SNOWFLAKE_STAGE="ontology_export"
FILE_FORMAT="ontology_export_format"
COPY_PARAMETERS="SINGLE=TRUE max_file_size=3221225472 header=TRUE overwrite=TRUE"
# CONNECT TO SNOWFLAKE
snowsql -c etl_user <<- EOSQL

--- CREATE FILE FORMAT
CREATE OR REPLACE FILE FORMAT $FILE_FORMAT
TYPE = CSV
FIELD_DELIMITER = '\t'
EMPTY_FIELD_AS_NULL = true 
TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS'
NULL_IF = ()
COMPRESSION=NONE
FIELD_OPTIONALLY_ENCLOSED_BY='"';

--- CREATE STAGE AREA
CREATE OR REPLACE STAGE $SNOWFLAKE_STAGE FILE_FORMAT = $FILE_FORMAT;

--- COPY ONTOLOGY TABLES IN THE STAGE

COPY INTO @$SNOWFLAKE_STAGE/ACT_COVID_V4.csv from ACT_COVID_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_CPT4_PX_V4.csv from ACT_CPT4_PX_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_DEM_V4.csv from ACT_DEM_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_HCPCS_PX_V4.csv from ACT_HCPCS_PX_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_ICD10CM_DX_V4.csv from ACT_ICD10CM_DX_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_ICD10PCS_PX_V4.csv from ACT_ICD10PCS_PX_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_ICD10_ICD9_DX_V4.csv from ACT_ICD10_ICD9_DX_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_ICD9CM_DX_V4.csv from ACT_ICD9CM_DX_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_ICD9CM_PX_V4.csv from ACT_ICD9CM_PX_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_LOINC_LAB_PROV_V4.csv from ACT_LOINC_LAB_PROV_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_LOINC_LAB_V4.csv from ACT_LOINC_LAB_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_MED_ALPHA_V4.csv from ACT_MED_ALPHA_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_MED_VA_V4.csv from ACT_MED_VA_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_SDOH_V4.csv from ACT_SDOH_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_VISIT_DETAILS_V4.csv from ACT_VISIT_DETAILS_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/ACT_VITAL_SIGNS_V4.csv from ACT_VITAL_SIGNS_V4 $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/SCHEMES.csv from SCHEMES $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/TABLE_ACCESS.csv from TABLE_ACCESS $COPY_PARAMETERS;

--- COPY DATA TABLES IN THE STAGE
COPY INTO @$SNOWFLAKE_STAGE/CONCEPT_DIMENSION.csv from I2B2DATA.CONCEPT_DIMENSION $COPY_PARAMETERS;
COPY INTO @$SNOWFLAKE_STAGE/QT_BREAKDOWN_PATH.csv from I2B2DATA.QT_BREAKDOWN_PATH $COPY_PARAMETERS;


--- DOWNLOAD ONTOLOGY TABLES FROM THE STAGE

GET @$SNOWFLAKE_STAGE/ACT_COVID_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_CPT4_PX_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_DEM_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_HCPCS_PX_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_ICD10CM_DX_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_ICD10PCS_PX_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_ICD10_ICD9_DX_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_ICD9CM_DX_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_ICD9CM_PX_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_LOINC_LAB_PROV_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_LOINC_LAB_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_MED_ALPHA_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_MED_VA_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_SDOH_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_VISIT_DETAILS_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/ACT_VITAL_SIGNS_V4.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/SCHEMES.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/TABLE_ACCESS.csv $LOCAL_STAGE;

--- DOWNLOAD DATA TABLES FROM THE STAGE
GET @$SNOWFLAKE_STAGE/CONCEPT_DIMENSION.csv $LOCAL_STAGE;
GET @$SNOWFLAKE_STAGE/QT_BREAKDOWN_PATH.csv $LOCAL_STAGE;

EOSQL
